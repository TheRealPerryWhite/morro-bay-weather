<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morro Bay (Back Bay) - Current Conditions</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">‚òÄÔ∏è</button>
        <h1>Morro Bay (Back Bay)</h1>
        <div class="location">35.3338¬∞N, 120.8473¬∞W</div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Loading current conditions...</div>

        <div id="data" style="display: none;">
            <div class="reading">
                <div class="reading-label">Temperature</div>
                <div class="reading-value">
                    <span id="temperature">--</span>
                    <span class="reading-unit">¬∞F</span>
                </div>
            </div>

            <div class="reading">
                <div class="reading-label">Rain (24 hours)</div>
                <div class="reading-value">
                    <span id="rainfall">--</span>
                    <span class="reading-unit">in</span>
                </div>
            </div>

            <div class="reading">
                <div class="reading-label">Wind Speed</div>
                <div class="reading-value">
                    <span id="windspeed">--</span>
                    <span class="reading-unit">mph</span>
                </div>
            </div>

            <div class="reading">
                <div class="reading-label">Current Tide</div>
                <div class="reading-value">
                    <span id="tide">--</span>
                    <span class="reading-unit">ft</span>
                    <span id="tideDirection" class="tide-direction"></span>
                </div>
            </div>

            <button id="refreshBtn" class="refresh-btn">Refresh Page</button>
            <div class="timestamp">Weather Station Last Updated <span id="timestamp">--</span></div>
        </div>
    </div>

    <script>
        const ERDDAP_BASE = 'https://erddap.cencoos.org/erddap/tabledap';
        const DATASET_ID = 'edu_calpoly_marine_morro_bay_met';
        const NOAA_TIDE_STATION = '9412110'; // Morro Bay station

        // Theme toggle functionality
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dodgers') {
                document.getElementById('themeToggle').textContent = '‚öæ';
            } else {
                updateThemeIcon(savedTheme);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = (currentTheme === 'dark' || currentTheme === 'dodgers') ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const toggle = document.getElementById('themeToggle');
            toggle.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Convert Celsius to Fahrenheit
        function celsiusToFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }

        // Convert m/s to mph
        function msToMph(ms) {
            return ms * 2.23694;
        }

        // Convert mm to inches
        function mmToInches(mm) {
            return mm * 0.0393701;
        }

        // Format relative time (e.g., "2 minutes ago")
        function formatRelativeTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const secondsAgo = Math.floor((now - date) / 1000);

            if (secondsAgo < 60) {
                return 'just now';
            } else if (secondsAgo < 3600) {
                const minutes = Math.floor(secondsAgo / 60);
                return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            } else if (secondsAgo < 86400) {
                const hours = Math.floor(secondsAgo / 3600);
                return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(secondsAgo / 86400);
                return `${days} day${days !== 1 ? 's' : ''} ago`;
            }
        }

        // Fetch weather data from ERDDAP
        async function fetchWeatherData() {
            try {
                // Get the most recent data point
                // ERDDAP constraint syntax: &time>=value&orderByMax("column")
                const url = `${ERDDAP_BASE}/${DATASET_ID}.json?time,air_temperature,wind_speed,lwe_thickness_of_precipitation_amount_cm_time__sum_over_p1d&orderByMax(%22time%22)`;

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                // ERDDAP returns data as [columnNames, ...rows]
                const columnNames = data.table.columnNames;
                const rows = data.table.rows;

                if (rows.length === 0) throw new Error('No data available');

                // Get the most recent row
                const latestRow = rows[0];

                // Map column names to values
                const dataMap = {};
                columnNames.forEach((name, index) => {
                    dataMap[name] = latestRow[index];
                });

                return {
                    timestamp: dataMap.time,
                    temperature: dataMap.air_temperature,
                    windSpeed: dataMap.wind_speed,
                    precipitation: dataMap['lwe_thickness_of_precipitation_amount_cm_time__sum_over_p1d']
                };
            } catch (error) {
                console.error('Weather data fetch error:', error);
                throw error;
            }
        }

        // Format date for NOAA API (YYYYMMdd HH:mm)
        function formatNOAADate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}${month}${day} ${hours}:${minutes}`;
        }

        // Fetch tide data from NOAA (with direction)
        async function fetchTideData() {
            try {
                const now = new Date();
                const beginDate = new Date(now.getTime() - (60 * 60 * 1000)); // 1 hour ago

                const params = new URLSearchParams({
                    'station': NOAA_TIDE_STATION,
                    'product': 'water_level',
                    'datum': 'MLLW',
                    'units': 'english',
                    'time_zone': 'lst_ldt',
                    'format': 'json',
                    'begin_date': formatNOAADate(beginDate),
                    'end_date': formatNOAADate(now)
                });

                const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?${params}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                if (data.data && data.data.length >= 2) {
                    const latest = parseFloat(data.data[data.data.length - 1].v);
                    const previous = parseFloat(data.data[data.data.length - 2].v);

                    return {
                        level: latest,
                        direction: latest > previous ? 'rising' : latest < previous ? 'falling' : 'steady'
                    };
                } else if (data.data && data.data.length === 1) {
                    return {
                        level: parseFloat(data.data[0].v),
                        direction: null
                    };
                }

                throw new Error('No tide data available');
            } catch (error) {
                console.error('Tide data fetch error:', error);
                return null; // Tide data is optional
            }
        }

        // Update the display
        async function updateDisplay() {
            const loadingEl = document.getElementById('loading');
            const dataEl = document.getElementById('data');
            const errorEl = document.getElementById('error');
            const refreshBtn = document.getElementById('refreshBtn');

            try {
                loadingEl.style.display = 'block';
                dataEl.style.display = 'none';
                errorEl.style.display = 'none';
                refreshBtn.disabled = true;

                // Fetch both weather and tide data
                const [weatherData, tideData] = await Promise.all([
                    fetchWeatherData(),
                    fetchTideData()
                ]);

                // Update temperature (convert C to F)
                const tempF = celsiusToFahrenheit(weatherData.temperature);
                document.getElementById('temperature').textContent = tempF.toFixed(1);

                // Update rainfall (convert mm to inches)
                const rainfallIn = mmToInches(weatherData.precipitation);
                document.getElementById('rainfall').textContent = rainfallIn.toFixed(2);

                // Update wind speed (convert m/s to mph)
                const windMph = msToMph(weatherData.windSpeed);
                document.getElementById('windspeed').textContent = windMph.toFixed(1);

                // Update tide with direction
                const tideEl = document.getElementById('tide');
                const tideDirectionEl = document.getElementById('tideDirection');

                if (tideData !== null) {
                    tideEl.textContent = tideData.level.toFixed(2);

                    // Show direction arrow if available
                    if (tideData.direction === 'rising') {
                        tideDirectionEl.textContent = '‚Üë';
                        tideDirectionEl.className = 'tide-direction tide-rising';
                    } else if (tideData.direction === 'falling') {
                        tideDirectionEl.textContent = '‚Üì';
                        tideDirectionEl.className = 'tide-direction tide-falling';
                    } else {
                        tideDirectionEl.textContent = '';
                    }
                } else {
                    tideEl.textContent = 'N/A';
                    tideDirectionEl.textContent = '';
                }

                // Update timestamp
                document.getElementById('timestamp').textContent = formatRelativeTime(weatherData.timestamp);

                // Show data, hide loading
                loadingEl.style.display = 'none';
                dataEl.style.display = 'block';

            } catch (error) {
                console.error('Error updating display:', error);
                errorEl.textContent = `Error loading data: ${error.message}`;
                errorEl.style.display = 'block';
                loadingEl.style.display = 'none';
            } finally {
                refreshBtn.disabled = false;
            }
        }

        // Easter egg: type "dodgers" to activate Dodgers theme
        let easterEggBuffer = '';
        document.addEventListener('keydown', function(e) {
            easterEggBuffer += e.key.toLowerCase();
            if (easterEggBuffer.length > 7) {
                easterEggBuffer = easterEggBuffer.slice(-7);
            }
            if (easterEggBuffer === 'dodgers') {
                document.documentElement.setAttribute('data-theme', 'dodgers');
                localStorage.setItem('theme', 'dodgers');
                document.getElementById('themeToggle').textContent = '‚öæ';
                easterEggBuffer = '';
            }
        });

        // Initialize
        initTheme();
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('refreshBtn').addEventListener('click', updateDisplay);
        updateDisplay();
    </script>
</body>
</html>
